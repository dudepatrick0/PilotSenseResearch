<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PilotSense Research Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #0a1628; color: white; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px; }
        h1 { color: #38d9a9; font-size: 24px; }
        .subtitle { color: #666; font-size: 14px; }
        .buttons { display: flex; gap: 10px; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; }
        .btn-primary { background: #38d9a9; color: #0a1628; }
        .btn-secondary { background: #1e3a5f; color: white; }
        .btn:hover { opacity: 0.9; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: #132039; padding: 20px; border-radius: 12px; }
        .stat-label { color: #888; font-size: 14px; margin-bottom: 5px; }
        .stat-value { font-size: 32px; font-weight: bold; }
        .green { color: #38d9a9; }
        .blue { color: #4da6ff; }
        .amber { color: #fbbf24; }
        .red { color: #f87171; }
        .section { background: #132039; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .section h2 { font-size: 18px; margin-bottom: 15px; }
        .status-row { display: flex; gap: 15px; margin-bottom: 20px; }
        .status-box { flex: 1; padding: 20px; border-radius: 10px; text-align: center; }
        .status-box.green-bg { background: rgba(56, 217, 169, 0.2); }
        .status-box.amber-bg { background: rgba(251, 191, 36, 0.2); }
        .status-box.red-bg { background: rgba(248, 113, 113, 0.2); }
        .status-box .value { font-size: 28px; font-weight: bold; }
        .status-box .label { color: #888; font-size: 14px; }
        .status-box .pct { color: #666; font-size: 12px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #1e3a5f; }
        th { color: #888; font-weight: normal; }
        .copy-section { background: #0d2137; border: 2px solid #38d9a9; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .copy-section h2 { color: #38d9a9; margin-bottom: 10px; }
        .copy-section p { color: #888; margin-bottom: 15px; }
        .data-preview { background: #132039; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; color: #ccc; margin-bottom: 15px; }
        .login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .login-box { background: #132039; padding: 40px; border-radius: 16px; width: 100%; max-width: 400px; text-align: center; }
        .login-box h1 { margin-bottom: 10px; }
        .login-box p { color: #888; margin-bottom: 30px; }
        .login-box input { width: 100%; padding: 15px; border-radius: 8px; border: 1px solid #1e3a5f; background: #0a1628; color: white; font-size: 16px; margin-bottom: 15px; }
        .login-box button { width: 100%; padding: 15px; }
        .error { color: #f87171; margin-top: 15px; display: none; }
        .hidden { display: none; }
        .loading { color: #888; }
        .tables-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .tables-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h1 style="color: #38d9a9;">ðŸ”¬ PilotSense Research</h1>
            <p>Enter password to access dashboard</p>
            <input type="password" id="passwordInput" placeholder="Password">
            <button class="btn btn-primary" id="loginBtn">Access Dashboard</button>
            <p class="error" id="loginError">Incorrect password</p>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        <div class="container">
            <header>
                <div>
                    <h1>ðŸ“Š PilotSense Research Dashboard</h1>
                    <p class="subtitle">Live beta data â€¢ Updated: <span id="lastUpdated">--</span></p>
                </div>
                <div class="buttons">
                    <button class="btn btn-secondary" id="refreshBtn">ðŸ”„ Refresh</button>
                    <button class="btn btn-secondary" id="csvBtn">ðŸ“¥ CSV</button>
                </div>
            </header>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Check-ins</div>
                    <div class="stat-value green" id="statCheckIns">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Pilots</div>
                    <div class="stat-value" id="statPilots">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Organizations</div>
                    <div class="stat-value" id="statOrgs">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Flights Tracked</div>
                    <div class="stat-value" id="statFlights">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Sleep (hrs)</div>
                    <div class="stat-value blue" id="statSleep">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg PVT (ms)</div>
                    <div class="stat-value" id="statPVT">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Surveys Completed</div>
                    <div class="stat-value" id="statSurveys">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Prediction Accuracy</div>
                    <div class="stat-value blue" id="statAccuracy">--%</div>
                </div>
            </div>

            <div class="section">
                <h2>Readiness Status Distribution</h2>
                <div class="status-row">
                    <div class="status-box green-bg">
                        <div class="value green" id="statGreen">--</div>
                        <div class="label">GREEN</div>
                        <div class="pct" id="statGreenPct">--%</div>
                    </div>
                    <div class="status-box amber-bg">
                        <div class="value amber" id="statAmber">--</div>
                        <div class="label">AMBER</div>
                        <div class="pct" id="statAmberPct">--%</div>
                    </div>
                    <div class="status-box red-bg">
                        <div class="value red" id="statRed">--</div>
                        <div class="label">RED</div>
                        <div class="pct" id="statRedPct">--%</div>
                    </div>
                </div>
            </div>

            <div class="copy-section">
                <h2>ðŸ“‹ Generate Case Study Data</h2>
                <p>Click the button below to copy your research data. Then paste it into Claude to generate your case study.</p>
                <div class="data-preview" id="dataPreview">Loading data...</div>
                <button class="btn btn-primary" id="copyDataBtn">ðŸ“‹ Copy Data for Case Study</button>
                <span id="copyStatus" style="margin-left: 15px; color: #38d9a9;"></span>
            </div>

            <div class="tables-grid">
                <div class="section">
                    <h2>Recent Check-ins</h2>
                    <table>
                        <thead>
                            <tr><th>ID</th><th>Date</th><th>Sleep</th><th>PVT</th><th>Status</th></tr>
                        </thead>
                        <tbody id="checkInsTable">
                            <tr><td colspan="5" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="section">
                    <h2>Post-Flight Surveys</h2>
                    <table>
                        <thead>
                            <tr><th>ID</th><th>Date</th><th>Fatigue</th><th>Accuracy</th></tr>
                        </thead>
                        <tbody id="surveysTable">
                            <tr><td colspan="4" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <footer style="text-align: center; color: #666; padding: 40px; font-size: 14px;">
                PilotSense Research Dashboard â€¢ Data anonymized for privacy
            </footer>
        </div>
    </div>

    <script>
        var PASSWORD = "HighasfuckPlane32!";
        var firebaseConfig = {
            apiKey: "AIzaSyAyfGTmaiu9Ps4c1YYGI6SM7wrIwcRO41A",
            authDomain: "pilotfit-4d564.firebaseapp.com",
            projectId: "pilotfit-4d564",
            storageBucket: "pilotfit-4d564.firebasestorage.app",
            messagingSenderId: "861806820372",
            appId: "1:861806820372:ios:1fe52f197fdadc53e17b01"
        };

        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();

        var allCheckIns = [];
        var allSurveys = [];
        var stats = {};

        document.getElementById('loginBtn').onclick = function() {
            if (document.getElementById('passwordInput').value === PASSWORD) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadData();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        };

        document.getElementById('passwordInput').onkeypress = function(e) {
            if (e.key === 'Enter') document.getElementById('loginBtn').click();
        };

        document.getElementById('refreshBtn').onclick = loadData;
        document.getElementById('copyDataBtn').onclick = copyData;
        document.getElementById('csvBtn').onclick = exportCSV;

        function loadData() {
            document.getElementById('lastUpdated').textContent = 'Loading...';
            
            Promise.all([
                db.collection('checkInRecords').orderBy('checkInDate', 'desc').limit(500).get(),
                db.collection('users').get(),
                db.collection('organizations').get(),
                db.collection('pilotFlights').get(),
                db.collection('completedFlights').get()
            ]).then(function(results) {
                var checkInsSnap = results[0];
                var usersSnap = results[1];
                var orgsSnap = results[2];
                var flightsSnap = results[3];
                var surveysSnap = results[4];

                allCheckIns = checkInsSnap.docs.map(function(doc, i) {
                    var d = doc.data();
                    return {
                        id: 'P' + String(i+1).padStart(3,'0'),
                        sleepHours: d.sleepHours || 0,
                        pvtScore: d.pvtScore || 0,
                        status: d.status || '',
                        date: d.checkInDate && d.checkInDate.toDate ? d.checkInDate.toDate() : new Date()
                    };
                });

                allSurveys = surveysSnap.docs.map(function(doc, i) {
                    var d = doc.data();
                    return {
                        id: 'S' + String(i+1).padStart(3,'0'),
                        postFlightFatigue: d.postFlightFatigue || 0,
                        predictionAccuracy: d.predictionAccuracy || '',
                        date: d.completedDate && d.completedDate.toDate ? d.completedDate.toDate() : new Date()
                    };
                });

                stats.totalCheckIns = allCheckIns.length;
                stats.totalPilots = usersSnap.size;
                stats.totalOrgs = orgsSnap.size;
                stats.totalFlights = flightsSnap.size;
                stats.totalSurveys = allSurveys.length;

                stats.greenCount = allCheckIns.filter(function(c) { return c.status === 'green'; }).length;
                stats.amberCount = allCheckIns.filter(function(c) { return c.status && c.status.indexOf('amber') >= 0; }).length;
                stats.redCount = allCheckIns.filter(function(c) { return c.status === 'red'; }).length;

                var sleepVals = allCheckIns.map(function(c) { return c.sleepHours; }).filter(function(s) { return s > 0; });
                stats.avgSleep = sleepVals.length > 0 ? (sleepVals.reduce(function(a,b) { return a+b; }, 0) / sleepVals.length).toFixed(1) : 0;

                var pvtVals = allCheckIns.map(function(c) { return c.pvtScore; }).filter(function(p) { return p > 0; });
                stats.avgPVT = pvtVals.length > 0 ? Math.round(pvtVals.reduce(function(a,b) { return a+b; }, 0) / pvtVals.length) : 0;

                var accurate = allSurveys.filter(function(s) { return s.predictionAccuracy === 'aboutRight'; }).length;
                stats.accuracyPct = allSurveys.length > 0 ? Math.round(accurate / allSurveys.length * 100) : 0;

                updateUI();
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
            }).catch(function(err) {
                console.error('Error:', err);
                document.getElementById('lastUpdated').textContent = 'Error loading data';
            });
        }

        function updateUI() {
            var total = stats.totalCheckIns || 1;

            document.getElementById('statCheckIns').textContent = stats.totalCheckIns;
            document.getElementById('statPilots').textContent = stats.totalPilots;
            document.getElementById('statOrgs').textContent = stats.totalOrgs;
            document.getElementById('statFlights').textContent = stats.totalFlights;
            document.getElementById('statSleep').textContent = stats.avgSleep;
            document.getElementById('statPVT').textContent = stats.avgPVT;
            document.getElementById('statSurveys').textContent = stats.totalSurveys;
            document.getElementById('statAccuracy').textContent = stats.accuracyPct + '%';

            document.getElementById('statGreen').textContent = stats.greenCount;
            document.getElementById('statAmber').textContent = stats.amberCount;
            document.getElementById('statRed').textContent = stats.redCount;
            document.getElementById('statGreenPct').textContent = Math.round(stats.greenCount/total*100) + '%';
            document.getElementById('statAmberPct').textContent = Math.round(stats.amberCount/total*100) + '%';
            document.getElementById('statRedPct').textContent = Math.round(stats.redCount/total*100) + '%';

            var checkInsHTML = '';
            allCheckIns.slice(0, 20).forEach(function(c) {
                var statusClass = c.status === 'green' ? 'green' : (c.status === 'red' ? 'red' : 'amber');
                var statusText = c.status === 'green' ? 'GREEN' : (c.status === 'red' ? 'RED' : 'AMBER');
                checkInsHTML += '<tr><td>' + c.id + '</td><td>' + c.date.toLocaleDateString() + '</td><td>' + (c.sleepHours || '--') + 'h</td><td>' + (c.pvtScore || '--') + 'ms</td><td class="' + statusClass + '">' + statusText + '</td></tr>';
            });
            document.getElementById('checkInsTable').innerHTML = checkInsHTML || '<tr><td colspan="5">No data yet</td></tr>';

            var surveysHTML = '';
            allSurveys.slice(0, 20).forEach(function(s) {
                var accText = s.predictionAccuracy === 'aboutRight' ? 'âœ“ Accurate' : (s.predictionAccuracy === 'tooLow' ? 'â†“ Too Low' : 'â†‘ Too High');
                surveysHTML += '<tr><td>' + s.id + '</td><td>' + s.date.toLocaleDateString() + '</td><td>' + s.postFlightFatigue + '/5</td><td>' + accText + '</td></tr>';
            });
            document.getElementById('surveysTable').innerHTML = surveysHTML || '<tr><td colspan="4">No surveys yet</td></tr>';

            updateDataPreview();
        }

        function updateDataPreview() {
            var total = stats.totalCheckIns || 1;
            var text = 'PILOTSENSE RESEARCH DATA\n';
            text += '========================\n\n';
            text += 'Total Check-ins: ' + stats.totalCheckIns + '\n';
            text += 'Total Pilots: ' + stats.totalPilots + '\n';
            text += 'Organizations: ' + stats.totalOrgs + '\n';
            text += 'Flights Tracked: ' + stats.totalFlights + '\n';
            text += 'Surveys Completed: ' + stats.totalSurveys + '\n\n';
            text += 'STATUS DISTRIBUTION:\n';
            text += '- GREEN: ' + stats.greenCount + ' (' + Math.round(stats.greenCount/total*100) + '%)\n';
            text += '- AMBER: ' + stats.amberCount + ' (' + Math.round(stats.amberCount/total*100) + '%)\n';
            text += '- RED: ' + stats.redCount + ' (' + Math.round(stats.redCount/total*100) + '%)\n\n';
            text += 'AVERAGES:\n';
            text += '- Avg Sleep: ' + stats.avgSleep + ' hours\n';
            text += '- Avg PVT: ' + stats.avgPVT + ' ms\n';
            text += '- Prediction Accuracy: ' + stats.accuracyPct + '%\n\n';
            text += 'Please analyze this data and write a professional case study for AME certification.';
            
            document.getElementById('dataPreview').textContent = text;
        }

        function copyData() {
            var text = document.getElementById('dataPreview').textContent;
            navigator.clipboard.writeText(text).then(function() {
                document.getElementById('copyStatus').textContent = 'âœ“ Copied! Now paste into Claude.';
                setTimeout(function() { document.getElementById('copyStatus').textContent = ''; }, 3000);
            });
        }

        function exportCSV() {
            var csv = 'ID,Date,Sleep_Hours,PVT_ms,Status\n';
            allCheckIns.forEach(function(c) {
                csv += c.id + ',' + c.date.toISOString().split('T')[0] + ',' + c.sleepHours + ',' + c.pvtScore + ',' + c.status + '\n';
            });
            var blob = new Blob([csv], { type: 'text/csv' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'pilotsense_data.csv';
            a.click();
        }
    </script>
</body>
</html>
